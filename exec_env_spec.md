# 実行環境・提出物仕様

## はじめに

今回のレイトレ合宿では実行環境として、CPU・GPUインスタンスともに複数インスタンス(2つ)を採用しています。
実行ファイルやアセットは両方のインスタンスに対して予め所定のパスに運営側で転送しておきますが、実行はひとつのインスタンスから始めます。この実行を開始するインスタンスをプライマリー(インスタンス)、2つ目のインスタンスをセカンダリー(インスタンス)と呼ぶことにします。

### 複数インスタンスのユースケース

典型的な複数インスタンスのユースケースとしては次の3つが考えられます。

1. そもそも複数インスタンスを使わない。
1. 複数インスタンスを使うが、実行ファイル間は直接通信は行わない。
1. 複数インスタンスを使い、実行ファイル間で直接通信する。

ケース1に関しては何も難しいことは考えることはありませんが、当然計算リソースがインスタンス1台分になります。ケース2やケース3ではインスタンス間でプログラムの起動(やデータの転送)を行う必要があります。ケース3は加えて実行ファイル間の直接通信のためにSSHとは異なるポートで通信する必要があります。運営側で予めインスタンス間のSSH通信のセットアップと、実行ファイル間の直接通信のためのファイアウォールにおけるポート12345の許可を設定しておきます。



## 各仕様

### 提出物
提出物の仕様は以下の構造とします。`<root directory>` をzipファイルに圧縮したものを提出してください。

```
<root directory> ... 名前はなんでも良し
├─ run.ps1 ... 実行開始スクリプト
├─ fps.txt ... 動画ファイルのfpsの数字だけを書き込む
├─ ***.exe ... 実行ファイル
├─ ***.pdf or pptx ... レンダラー紹介スライド
└─ etc ... アセット
```

- zipファイルの上限サイズは1GiB(=1024MiB)です。
- `fps.txt` にフレームレートの数字だけを書き込んでください。フレームレートは最低10、最高60とします。

### 実行環境

`<root directory>` を両インスタンスのホームディレクトリに配置します。すなわち `run.ps1` は次の絶対パスに配置されることになります。\
`C:\Users\Administrator\<root directory>\run.ps1`

本番では作業ディレクトリは `<root directory>` として `run.ps1` を次のように実行します。\
`.\run.ps1 <プライマリーのプライベートIP> <セカンダリーのプライベートIP>`\
インスタンス間はプライベートIPで通信できるようになっているので、これによってセカンダリーインスタンスにおけるプログラムの起動やデータの転送を実行できます。例えば次のようにしてプライマリーからセカンダリーの実行ファイルを起動できます。\
``ssh -i $home\.ssh\id_rsa administrator@<セカンダリーのプライベートIP> '`$home\<root directory>\program.exe'``

- 画像出力は.pngまたは.jpgで000.png, 001.png, ...と0開始、3桁の連番で `<root directory>` に出力してください。\
  セカンダリーにおける出力画像はプライマリーに転送する必要はありません。運営側でプライマリー側に転送します。(ただしファイル名はかぶらないよう注意)
- キーボードやマウスの操作を要求せずに自動でレンダリングしてください。
- 制限時間内に自動で終了するようにしてください。
- エラーは標準出力か標準エラー出力かログファイルに出力してください。(ウィンドウやダイアログを出さないでください)
- インスタンス間通信を除いてインターネット接続をしないで下さい。
- python 3.11.4がインストールされています。\
  pythonライブラリとしては数値計算用にnumpy, scipy、画像処理にPillow、SSH操作用にparamikoをインストールしています。

## 複数インスタンスを試す

複数インスタンスを使うプログラムのテストができるようにインスタンス間通信設定手順を以下に示します。

### 下準備
手元PCとインスタンス間のRDP/SSH接続、インスタンス間の通信を許可するセキュリティグループを予め作成しておきます。

1. AWSマネジメントコンソールにログイン。
1. サービス > コンピューティング > EC2
1. ネットワーク & セキュリティ > セキュリティグループ
1. 「セキュリティグループを作成」をクリック。
   1. 適当なセキュリティグループ名を入力。
   1. インバウンドルールとして以下の2つを追加。\
      タイプ: "RDP", ソース: "マイIP"\
      タイプ: "SSH", ソース: "マイIP"
   1. 「セキュリティグループを作成」をクリック。
1. 作成したセキュリティグループが表示されるので「インバウンドのルールを編集」をクリック。
   1. タイプ: "すべてのトラフィック", ソース: "カスタム" でソースのテキストボックスをクリックして自身のセキュリティグループを選ぶ。
   1. 「ルールを保存」をクリック。

### インスタンスの起動と起動後の設定

1. 上記セキュリティグループと、当リポジトリ内の userdata.yml をユーザーデータに指定してWindowsインスタンスを2つ起動する。\
   起動時スクリプト内でWindowsにおけるSSHサーバーの設定と手元PCとの通信許可、アプリケーション間通信のためのポート12345のファイアウォール設定を記述しています。
1. それぞれのインスタンスにリモートデスクトップで接続する。\
   RDPでログインまで済まさないと上記スクリプトが走らないようです。\
   少々待つ必要がありますが、 `C:\ProgramData\ssh` 内にファイルが生成されていればスクリプト実行が完了しています。
1. "手元"のPCのPowershell上で `set_up_inter_instance_ssh.ps1` を次のように実行する(数十秒で終わります)。\
   `.\set_up_inter_instance_ssh.ps1 <pemファイルのパス> <インスタンス1のパブリックIP> <インスタンス1のプライベートIP> <インスタンス2のパブリックIP> <インスタンス2のプライベートIP>`\
   パブリック/プライベートIPアドレスはEC2のインスタンス一覧から確認できますが、RDP接続時にデスクトップの壁紙にも表示されています。\
   手元PCからそれぞれのインスタンスに対してSSH接続を続けるか2回聞かれるのでyesを入力します。\
   両インスタンスともに手元PCとの接続には同じpemファイルを指定して起動していることを仮定しています。\
   このスクリプトはそれぞれのインスタンス上でSSH通信用のキーペアの生成、サーバー側における公開鍵の登録、クライアント側におけるホストの登録を行います。



## サンプルプログラム

ユースケース2, 3の例としてサンプルプログラムを当リポジトリに含めています。

- samples/usecase2\
  それぞれのインスタンスにおけるレンダラー同士は直接通信せず、コマンドライン引数によってレンダリングするフレームをわけています。(`run.ps1` から呼ばれる)Pythonコード中にプライマリーインスタンスにおけるプログラム実行と、SSHによるセカンダリーインスタンスにおけるプログラム実行を記述しています。
- samples/usecase3 (作成中)

リポジトリのルートにあるCMakeListsからプロジェクトをビルドできます。gitのsubmoduleを使っているので\
`git submodule update --init --recursive`\
を実行してください。\
またこれらを用いた提出物の例が `usecase2_submission.zip` , `usecase3_submission.zip` (作成中) になります。
